name: Build Performance Monitor

on:
  workflow_dispatch:
  schedule:
    # Ð—Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ Ñ€Ð°Ð· Ð² Ð½ÐµÐ´ÐµÐ»ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð½Ð¸Ñ‚Ð¾Ñ€Ð¸Ð½Ð³Ð° Ð¿Ñ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚Ð¸
    - cron: '0 6 * * 1'  # ÐŸÐ¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº Ð² 6 ÑƒÑ‚Ñ€Ð°

env:
  IMAGE_NAME: cb500-monitor
  BASE_IMAGE_NAME: cb500-base
  REGISTRY: docker.io

jobs:
  performance-test:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Test Original Build (No Cache)
        id: original
        run: |
          echo "ðŸŒ Testing original build strategy..."
          start_time=$(date +%s)
          docker buildx build --no-cache -f Dockerfile -t test-original . > /dev/null 2>&1
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "duration=$duration" >> $GITHUB_OUTPUT
          echo "Original build took: ${duration}s"

      - name: Test Microsoft Base Build
        id: microsoft
        run: |
          echo "ðŸ§ Testing Microsoft Playwright base build..."
          start_time=$(date +%s)
          docker buildx build --no-cache -f Dockerfile.fast -t test-microsoft . > /dev/null 2>&1
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "duration=$duration" >> $GITHUB_OUTPUT
          echo "Microsoft base build took: ${duration}s"

      - name: Test Custom Base Build (if exists)
        id: custom
        continue-on-error: true
        run: |
          echo "ðŸš€ Testing custom base build..."
          start_time=$(date +%s)
          docker buildx build -f Dockerfile.superfast -t test-custom . > /dev/null 2>&1
          end_time=$(date +%s)
          duration=$((end_time - start_time))
          echo "duration=$duration" >> $GITHUB_OUTPUT
          echo "Custom base build took: ${duration}s"

      - name: Calculate Savings
        id: savings
        run: |
          original=${{ steps.original.outputs.duration }}
          microsoft=${{ steps.microsoft.outputs.duration }}
          custom=${{ steps.custom.outputs.duration || '0' }}
          
          # Ð’Ñ‹Ñ‡Ð¸ÑÐ»ÑÐµÐ¼ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸ÑŽ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸
          if [ "$microsoft" -gt 0 ]; then
            microsoft_savings=$(( (original - microsoft) * 100 / original ))
            echo "microsoft_savings=$microsoft_savings" >> $GITHUB_OUTPUT
          fi
          
          if [ "$custom" -gt 0 ]; then
            custom_savings=$(( (original - custom) * 100 / original ))
            echo "custom_savings=$custom_savings" >> $GITHUB_OUTPUT
          fi

      - name: Generate Report
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          # ðŸ“Š Build Performance Report
          
          ## â±ï¸ Build Times Comparison
          
          | Strategy | Duration | Speed Improvement | Image Size |
          |----------|----------|-------------------|------------|
          | ðŸŒ Original (Dockerfile) | ${{ steps.original.outputs.duration }}s | Baseline | $(docker images --format "{{.Size}}" test-original 2>/dev/null \|\| echo "N/A") |
          | ðŸ§ Microsoft Base | ${{ steps.microsoft.outputs.duration }}s | ${{ steps.savings.outputs.microsoft_savings || 'N/A' }}% faster | $(docker images --format "{{.Size}}" test-microsoft 2>/dev/null \|\| echo "N/A") |
          | ðŸš€ Custom Base | ${{ steps.custom.outputs.duration || 'N/A' }}s | ${{ steps.savings.outputs.custom_savings || 'N/A' }}% faster | $(docker images --format "{{.Size}}" test-custom 2>/dev/null \|\| echo "N/A") |
          
          ## ðŸ’¡ Recommendations
          
          EOF
          
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ð¸Ð¸
          original=${{ steps.original.outputs.duration }}
          microsoft=${{ steps.microsoft.outputs.duration }}
          custom=${{ steps.custom.outputs.duration || '0' }}
          
          if [ "$custom" -gt 0 ] && [ "$custom" -lt 60 ]; then
            echo "âœ… **Custom base strategy is optimal** - Build time under 1 minute!" >> $GITHUB_STEP_SUMMARY
          elif [ "$microsoft" -lt 120 ]; then
            echo "ðŸ§ **Microsoft base strategy recommended** - Good balance of speed and simplicity" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ **Consider optimizing build strategy** - All builds are taking longer than expected" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time Savings per Build:**" >> $GITHUB_STEP_SUMMARY
          if [ "$microsoft" -gt 0 ]; then
            microsoft_saved=$((original - microsoft))
            echo "- Microsoft base saves: ${microsoft_saved}s per build" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "$custom" -gt 0 ]; then
            custom_saved=$((original - custom))
            echo "- Custom base saves: ${custom_saved}s per build" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Cleanup
        if: always()
        run: |
          docker rmi test-original test-microsoft test-custom 2>/dev/null || true
          docker system prune -f

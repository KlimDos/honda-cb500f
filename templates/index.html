{% extends 'base.html' %}
{% block title %}CB500F Deal Evaluator{% endblock %}
{% block content %}
  <h1 class="page-title">Honda CB500F Калькулятор сделки</h1>
  <form method="post" class="grid-form card elevate" autocomplete="on">
    <label>Год <input type="number" name="year" required value="{{ result.year if result else '' }}" /></label>
    <label>Пробег (мили) <input type="number" name="mileage" required value="{{ result.mileage if result else '' }}" /></label>
    <label>Цена из объявления ($) <input type="number" name="price" step="0.01" required value="{{ result.asking if result else '' }}" /></label>
    <label>Штат
      <select name="region" required>
        {% for r in regions %}
          <option value="{{r}}" {% if result and result.region==r %}selected{% endif %}>{{r}}</option>
        {% endfor %}
      </select>
    </label>
    <label>Состояние
      <select name="condition" required>
        {% for c in conditions %}
          <option value="{{c}}" {% if result and result.condition==c %}selected{% endif %}>{{c}}</option>
        {% endfor %}
      </select>
    </label>
    <fieldset class="accessories field-group">
      <legend>Accessories</legend>
      {% for acc,val in accessories.items() %}
        {% set ru = accessories_ru.get(acc) %}
        <label class="chip" title="{{ ru[1] if ru else acc }}"><input type="checkbox" name="{{acc}}" {% if result and result.selected_accessories[acc] %}checked{% endif %}> {{ ru[0] if ru else acc }}</label>
      {% endfor %}
    </fieldset>
    <div class="actions">
      <button type="submit" class="btn primary">Рассчитать</button>
      <button type="reset" class="btn subtle" onclick="document.querySelectorAll('form input[type=checkbox]').forEach(c=>c.checked=false)">Сброс</button>
    </div>
  </form>

  {% if result %}
  <section class="result card elevate">
    <div class="result-header">
      {% set cls = result.classification %}
      <h2>Результат <span class="badge {{ cls|lower|replace(' ', '-') }}">{{ cls }}</span></h2>
    </div>
    <div class="result-metrics">
      <div class="metric"><span>Справедливая</span><strong>${{ '%.0f'|format(result.fair) }}</strong></div>
      <div class="metric"><span>Коридор покупки</span><strong>${{ '%.0f'|format(result.band[0]) }} - {{ '%.0f'|format(result.band[1]) }}</strong></div>
      <div class="metric"><span>Год</span><strong>{{ result.year }}</strong></div>
      <div class="metric"><span>Пробег</span><strong>{{ result.mileage }}</strong></div>
      <div class="metric"><span>Штат</span><strong>{{ result.region }}</strong></div>
      <div class="metric"><span>Состояние</span><strong>{{ result.condition }}</strong></div>
    </div>
    <details class="breakdown">
      <summary>Детализация</summary>
      <table class="breakdown-table">
        <thead><tr><th>Component</th><th>Value</th></tr></thead>
        <tbody>
        {% for k,v in result.components.items() %}
          <tr><td>{{k}}</td><td>{{ '%.2f'|format(v) if v is number else v }}</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </details>
  </section>
  {% endif %}
{% endblock %}

